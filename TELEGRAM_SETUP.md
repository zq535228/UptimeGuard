# Telegram 通知设置指南

UptimeGuard 支持通过 Telegram 发送网站监控通知。当网站连续失败超过设定阈值时，会自动发送警报；当网站恢复时，也会发送恢复通知。

## 功能特性

- 🚨 **故障警报**: 当网站连续失败达到阈值时发送通知
- ✅ **恢复通知**: 当网站从故障状态恢复时发送通知
- ⚙️ **灵活配置**: 支持 UI 配置和环境变量配置
- 🧪 **连接测试**: 内置连接测试功能
- 📊 **详细日志**: 所有通知操作都会记录到日志中

## 设置步骤

### 1. 创建 Telegram Bot

1. 在 Telegram 中搜索 `@BotFather`
2. 发送 `/newbot` 命令
3. 按提示输入机器人名称和用户名
4. 复制获得的 Bot Token（格式类似：`123456789:ABCdefGHIjklMNOpqrsTUVwxyz`）

### 2. 获取 Chat ID

#### 方法一：通过 API 获取
1. 将机器人添加到群组或开始私聊
2. 发送任意消息给机器人
3. 访问：`https://api.telegram.org/bot<YOUR_BOT_TOKEN>/getUpdates`
4. 在返回的 JSON 中找到 `chat.id` 字段

#### 方法二：使用现有机器人
1. 在群组中发送 `/start@your_bot_username`
2. 访问上述 API 链接获取 Chat ID

### 3. 配置通知

#### 方法一：通过 UI 配置（推荐）

1. 启动 UptimeGuard 应用
2. 展开 "🔔 Telegram 通知配置" 区域
3. 填写以下信息：
   - **启用 Telegram 通知**: 勾选启用
   - **Bot Token**: 输入从 BotFather 获得的 Token
   - **Chat ID**: 输入目标聊天 ID
   - **连续失败阈值**: 设置连续失败多少次后发送通知（默认 10 次）
4. 点击 "🧪 测试连接" 验证配置
5. 点击 "💾 保存配置" 保存设置

#### 方法二：通过环境变量配置

```bash
export TELEGRAM_BOT_TOKEN="your_bot_token_here"
export TELEGRAM_CHAT_ID="your_chat_id_here"
export TELEGRAM_ENABLED="true"
export TELEGRAM_FAILURE_THRESHOLD="10"
```

### 4. 测试配置

运行测试脚本验证配置：

```bash
python test_telegram.py
```

## 通知消息格式

### 故障警报
```
🚨 网站监控警报

📊 网站信息:
• 名称: 示例网站
• URL: https://example.com
• 连续失败: 10 次

⏰ 检测时间: 2024-01-15 14:30:25

⚠️ 状态: 网站不可访问

🔍 错误详情: 连接超时

请及时检查网站状态！
```

### 恢复通知
```
✅ 网站恢复通知

📊 网站信息:
• 名称: 示例网站
• URL: https://example.com
• 响应延迟: 150 ms

⏰ 恢复时间: 2024-01-15 14:35:10

🎉 状态: 网站已恢复正常访问
```

## 配置说明

### 连续失败阈值

- **默认值**: 10 次
- **范围**: 1-100 次
- **说明**: 当网站连续失败达到此次数时，发送故障警报
- **建议**: 根据监控频率调整，避免误报

### 监控频率

- **默认间隔**: 15 秒
- **配置位置**: `app.py` 中的 `interval_seconds` 参数
- **建议**: 根据网站重要性调整监控频率

## 故障排除

### 常见问题

1. **测试连接失败**
   - 检查 Bot Token 是否正确
   - 检查 Chat ID 是否正确
   - 确保机器人已添加到目标聊天

2. **收不到通知**
   - 检查是否启用了通知功能
   - 检查连续失败阈值设置
   - 查看日志文件中的错误信息

3. **权限问题**
   - 确保机器人有发送消息的权限
   - 检查群组中机器人的管理员权限

### 日志查看

所有 Telegram 相关操作都会记录到日志中：

```bash
tail -f logs/uptime.log | grep TELEGRAM
```

## 安全建议

1. **保护 Bot Token**: 不要将 Bot Token 提交到版本控制系统
2. **使用环境变量**: 生产环境建议使用环境变量配置
3. **限制访问**: 只将机器人添加到必要的聊天中
4. **定期轮换**: 定期更换 Bot Token 以提高安全性

## 高级配置

### 自定义通知消息

可以修改 `telegram_notifier.py` 中的消息格式函数来自定义通知内容。

### 多群组通知

可以通过修改配置支持向多个群组发送通知。

### 通知频率限制

可以添加通知频率限制，避免短时间内重复发送相同通知。
