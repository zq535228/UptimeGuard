# UptimeGuard Telegram 通知功能实现总结

## 🎯 实现目标

为 UptimeGuard 网站监控工具添加 Telegram 通知功能，当网站连续失败超过 10 次时自动发送通知。

## ✅ 已完成功能

### 1. 核心模块

#### `telegram_config.py` - 配置管理
- ✅ 支持从环境变量和配置文件读取配置
- ✅ 提供配置保存和更新功能
- ✅ 配置验证和状态检查
- ✅ 灵活的阈值设置（默认 10 次）

#### `telegram_notifier.py` - 通知发送
- ✅ 故障警报消息格式化
- ✅ 恢复通知消息格式化
- ✅ 连接测试功能
- ✅ 错误处理和日志记录
- ✅ 支持 HTML 格式消息

#### `monitor.py` - 监控集成
- ✅ 集成连续失败检测逻辑
- ✅ 达到阈值时发送故障警报
- ✅ 恢复时发送恢复通知
- ✅ 避免重复通知（只在首次达到阈值时发送）
- ✅ 详细的日志记录

#### `ui.py` - 用户界面
- ✅ 添加 Telegram 配置界面
- ✅ 实时配置状态显示
- ✅ 连接测试功能
- ✅ 配置重置功能
- ✅ 详细的使用说明

### 2. 辅助工具

#### `test_telegram.py` - 测试脚本
- ✅ 配置验证
- ✅ 连接测试
- ✅ 消息发送测试

#### `demo_telegram.py` - 演示脚本
- ✅ 交互式配置设置
- ✅ 模拟监控场景演示
- ✅ 完整的通知流程展示

#### `TELEGRAM_SETUP.md` - 设置指南
- ✅ 详细的配置步骤
- ✅ 故障排除指南
- ✅ 安全建议

## 🔧 技术特性

### 配置管理
- **多源配置**: 支持环境变量和配置文件
- **优先级**: 环境变量 > 配置文件
- **验证**: 自动验证配置完整性
- **持久化**: 配置自动保存到文件

### 通知逻辑
- **智能触发**: 只在首次达到阈值时发送警报
- **恢复通知**: 从故障状态恢复时发送通知
- **防重复**: 避免短时间内重复发送相同通知
- **详细日志**: 所有操作都有日志记录

### 消息格式
- **HTML 支持**: 支持富文本格式
- **信息丰富**: 包含网站信息、时间、错误详情
- **表情符号**: 使用表情符号增强可读性
- **结构化**: 清晰的信息层次结构

## 📊 配置参数

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `failure_threshold` | 10 | 连续失败阈值 |
| `bot_token` | - | Telegram Bot Token |
| `chat_id` | - | 目标聊天 ID |
| `enabled` | false | 是否启用通知 |

## 🚀 使用方法

### 1. 通过 UI 配置
1. 启动应用：`python app.py`
2. 展开 "🔔 Telegram 通知配置" 区域
3. 填写 Bot Token 和 Chat ID
4. 点击 "🧪 测试连接" 验证
5. 点击 "💾 保存配置"

### 2. 通过环境变量配置
```bash
export TELEGRAM_BOT_TOKEN="your_bot_token"
export TELEGRAM_CHAT_ID="your_chat_id"
export TELEGRAM_ENABLED="true"
export TELEGRAM_FAILURE_THRESHOLD="10"
```

### 3. 通过代码配置
```python
from telegram_config import update_config
update_config(
    bot_token="your_bot_token",
    chat_id="your_chat_id",
    enabled=True,
    failure_threshold=10
)
```

## 🧪 测试和验证

### 运行测试脚本
```bash
python test_telegram.py
```

### 运行演示脚本
```bash
python demo_telegram.py
```

### 查看日志
```bash
tail -f logs/uptime.log | grep TELEGRAM
```

## 📝 日志示例

```
[2024-01-15 14:30:25] [TELEGRAM] 发送故障警报: 示例网站 (https://example.com) - 连续失败 10 次
[2024-01-15 14:35:10] [TELEGRAM] 发送恢复通知: 示例网站 (https://example.com) - 响应延迟 150 ms
```

## 🔒 安全考虑

1. **Token 保护**: Bot Token 在 UI 中显示为密码字段
2. **环境变量**: 生产环境建议使用环境变量
3. **权限控制**: 只向指定聊天发送通知
4. **错误处理**: 完善的异常处理机制

## 🎉 功能亮点

- ✅ **零配置启动**: 不配置也能正常运行
- ✅ **智能通知**: 避免重复和误报
- ✅ **用户友好**: 直观的 UI 配置界面
- ✅ **详细文档**: 完整的使用指南
- ✅ **测试工具**: 内置测试和演示功能
- ✅ **日志完整**: 所有操作都有记录
- ✅ **错误处理**: 健壮的异常处理
- ✅ **可扩展**: 易于添加新功能

## 🔄 工作流程

1. **监控检测**: 每 15 秒检测一次网站状态
2. **失败计数**: 记录连续失败次数
3. **阈值判断**: 达到设定阈值时触发通知
4. **发送警报**: 发送格式化的故障警报
5. **恢复检测**: 检测到恢复时发送恢复通知
6. **日志记录**: 记录所有通知操作

这个实现完全满足了您的需求：当 `consecutive_failures` 连续大于 10 次时，使用 Telegram 发送通知。同时提供了完整的配置管理、用户界面和测试工具。
